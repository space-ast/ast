/// @file      TimeSystem.cpp
/// @brief     
/// @details   ~
/// @author    jinke18
/// @date      21.11.2025
/// @copyright 版权所有 (C) 2025-present, ast项目.

/// ast项目（https://github.com/space-ast/ast）
/// 本项目基于 Apache 2.0 开源许可证分发。
/// 您可在遵守许可证条款的前提下使用、修改和分发本软件。
/// 许可证全文请见：
/// 
///    http://www.apache.org/licenses/LICENSE-2.0
/// 
/// 重要须知：
/// 软件按“现有状态”提供，无任何明示或暗示的担保条件。
/// 除非法律要求或书面同意，作者与贡献者不承担任何责任。
/// 使用本软件所产生的风险，需由您自行承担。

#include "TimeSystem.hpp" 
#include "AstCore/DateTime.hpp"
#include "AstCore/JulianDate.hpp"
#include "AstCore/RunTime.hpp"
#include <math.h>


AST_NAMESPACE_BEGIN

double aJulianCenturyFromJ2000(const JulianDate& jd)
{
    return ((jd.day() - kJ2000Epoch) + jd.dayFractional()) / 36525.;
}

double aJulianDayFromJ2000(const JulianDate& jd)
{
    return (jd.day() - kJ2000Epoch) + jd.dayFractional();
}

void aTAIToUTC(const JulianDate& jdTAI, JulianDate& jdUTC)
{
    // @note: TAI 时间 = UTC 时间 + 闰秒
    // 闰秒只由UTC儒略日的整数部分确定
    // 在这里，让TAI时间和UTC时间的整数部分保持一致，可直接通过jdTAI.day()计算闰秒
    double leapsec = aLeapSecondUTC(jdTAI.day());
    jdUTC = jdTAI - leapsec;
}

void aTAIToUTC(const DateTime& dttmTAI, DateTime& dttmUTC)
{
    double leapsec = aLeapSecondUTCMJD(dttmTAI.date().toMJD());
    dttmUTC = dttmTAI;
    dttmUTC.addSecondsUTC(-leapsec); // 减去闰秒，得到UTC时间，这里会进行规范化
}

void aUTCToTAI(const JulianDate& jdUTC, JulianDate& jdTAI)
{
    // @note: TAI 时间 = UTC 时间 + 闰秒
    // 闰秒只由UTC儒略日的整数部分确定，避免奇异问题
    double leapsec = aLeapSecondUTC(jdUTC.day());
    jdTAI = jdUTC + leapsec;
}


void aUTCToTAI(const DateTime& dttmUTC, DateTime& dttmTAI)
{
    double leapsec = aLeapSecondUTCMJD(dttmUTC.date().toMJD());
    dttmTAI = dttmUTC;
    dttmTAI.addSeconds(leapsec); // 加上闰秒，得到TAI时间，这里会进行规范化
}

void aUTCToTT(const JulianDate& jdUTC, JulianDate& jdTT)
{
    aUTCToTAI(jdUTC, jdTT);
    aTAIToTT(jdTT, jdTT);
}

void aUTCToTT(const DateTime& dttmUTC, DateTime& dttmTT)
{
    aUTCToTAI(dttmUTC, dttmTT);
    aTAIToTT(dttmTT, dttmTT);
}

void aTTToUTC(const JulianDate& jdTT, JulianDate& jdUTC)
{
    aTTToTAI(jdTT, jdUTC);
    aTAIToUTC(jdUTC, jdUTC);
}

void aTTToUTC(const DateTime& dttmTT, DateTime& dttmUTC)
{
    aTTToTAI(dttmTT, dttmUTC);
    aTAIToUTC(dttmUTC, dttmUTC);
}


void aTTToTDB(const JulianDate& jdTT, JulianDate& jdTDB)
{
    double tdb_tt = aTDBMinusTT(jdTT);
    jdTDB = jdTT + tdb_tt;
}

void aTTToTDB(const DateTime& dttmTT, DateTime& dttmTDB)
{
    double tdb_tt = aTDBMinusTT(JulianDate::FromDateTime(dttmTT));
    dttmTDB = dttmTT;
    dttmTDB.addSeconds(tdb_tt);
}


double aTDBMinusTT(const JulianDate& jdTT)
{
#define USE_X -3
#if (USE_X == -3)
	double jdfromj2000 = aJulianDayFromJ2000(jdTT);
	double arg = (0.01720197 * jdfromj2000 + 6.239996);
	return 0.001657 * sin(arg + 0.01671*sin(arg));
#elif (USE_X == -2)
	double jctt = aJulianCenturyFromJ2000(jdTT);
	double arg = kDegToRad * (35999.05034 * jctt + 357.5277233);
	return 0.001658 * sin(arg + 0.0167*sin(arg));
#elif (USE_X == -1)
	double jctt = aJulianCenturyFromJ2000(jdTT);
	double arg = kDegToRad*(35999.05034 * jctt + 357.5277233);
	return 0.001658 * sin(arg) + 0.00001385 * sin(arg + arg);
#elif (USE_X == 0)
    double jctt = aJulianCenturyFromJ2000(jdTT);
	double tdb_minus_tt =
		+ 0.001657 * sin(628.3076 * jctt + 6.2401)
		+ 0.000022 * sin(575.3385 * jctt + 4.2970)
		+ 0.000014 * sin(1256.6152 * jctt + 6.1969)
		+ 0.000005 * sin(606.9777 * jctt + 4.0212)
		+ 0.000005 * sin(52.9691 * jctt + 0.4444)
		+ 0.000002 * sin(21.3299 * jctt + 5.5431)
		+ 0.000010 * jctt * sin(628.3076 * jctt + 4.2490)
		;
    return tdb_minus_tt;
#elif (USE_X == 1)
    double jctt = aJulianCenturyFromJ2000(jdTT);
	const double& dtr = kDegToRad;
	double& t = jctt;
	double tdb_minus_tt =
		+1656.675 * sin(dtr * (35999.3729 * t + 357.5287))
		+ 22.418 * sin(dtr * (32964.467 * t + 246.199))
		+ 13.84 * sin(dtr * (71998.746 * t + 355.057))
		+ 4.77 * sin(dtr * (3034.906 * t + 25.463))
		+ 4.677 * sin(dtr * (34777.259 * t + 230.394))
		+ 10.216 * t * sin(dtr * (35999.373 * t + 243.451))
		+ 0.171 * t * sin(dtr * (71998.746 * t + 240.98))
		+ 0.027 * t * sin(dtr * (1222.114 * t + 194.661))
		+ 0.027 * t * sin(dtr * (3034.906 * t + 336.061))
		+ 0.026 * t * sin(dtr * (-20.186 * t + 9.382))
		+ 0.007 * t * sin(dtr * (29929.562 * t + 264.911))
		+ 0.006 * t * sin(dtr * (150.678 * t + 59.775))
		+ 0.005 * t * sin(dtr * (9037.513 * t + 256.025))
		+ 0.043 * t * sin(dtr * (35999.373 * t + 151.121));

	tdb_minus_tt = 0.000001 * tdb_minus_tt;
    return tdb_minus_tt;
#elif (USE_X == 2) // 前127项系数，可以保证100ns精度; An Analytical Formula for the Time Transformation TB-TT
    double  tsol, w, elsun, emsun, d, elj, els, wt, w0, w1, w2, w3, w4,
        wf, wj;
    int j;
    static const double fairhd[127][3] = {
   /* 1, 10 */
      { 1656.674564e-6,     6283.075943033,  6.240054195 },
      {   22.417471e-6,     5753.384970095,  4.296977442 },
      {   13.839792e-6,    12566.151886066,  6.196904410 },
      {    4.770086e-6,      529.690965095,  0.444401603 },
      {    4.676740e-6,     6069.776754553,  4.021195093 },
      {    2.256707e-6,      213.299095438,  5.543113262 },
      {    1.694205e-6,       -3.523118349,  5.025132748 },
      {    1.554905e-6,    77713.772618729,  5.198467090 },
      {    1.276839e-6,     7860.419392439,  5.988822341 },
      {    1.193379e-6,     5223.693919802,  3.649823730 },
   /* 11, 20 */
      {    1.115322e-6,     3930.209696220,  1.422745069 },
      {    0.794185e-6,    11506.769769794,  2.322313077 },
      {    0.600309e-6,     1577.343542448,  2.678271909 },
      {    0.496817e-6,     6208.294251424,  5.696701824 },
      {    0.486306e-6,     5884.926846583,  0.520007179 },
      {    0.468597e-6,     6244.942814354,  5.866398759 },
      {    0.447061e-6,       26.298319800,  3.615796498 },
      {    0.435206e-6,     -398.149003408,  4.349338347 },
      {    0.432392e-6,       74.781598567,  2.435898309 },
      {    0.375510e-6,     5507.553238667,  4.103476804 },
   /* 21, 30 */
      {    0.243085e-6,     -775.522611324,  3.651837925 },
      {    0.230685e-6,     5856.477659115,  4.773852582 },
      {    0.203747e-6,    12036.460734888,  4.333987818 },
      {    0.173435e-6,    18849.227549974,  6.153743485 },
      {    0.159080e-6,    10977.078804699,  1.890075226 },
      {    0.143925e-6,     -796.298006816,  5.957517795 },
      {    0.137927e-6,    11790.629088659,  1.135934669 },
      {    0.119979e-6,       38.133035638,  4.551585768 },
      {    0.118971e-6,     5486.777843175,  1.914547226 },
      {    0.116120e-6,     1059.381930189,  0.873504123 },      
   /* 31, 40 */
      {    0.101868e-6,    -5573.142801634,  5.984503847 },
      {    0.098358e-6,     2544.314419883,  0.092793886 },
      {    0.080164e-6,      206.185548437,  2.095377709 },
      {    0.079645e-6,     4694.002954708,  2.949233637 },
      {    0.075019e-6,     2942.463423292,  4.980931759 },
      {    0.064397e-6,     5746.271337896,  1.280308748 },
      {    0.063814e-6,     5760.498431898,  4.167901731 },
      {    0.062617e-6,       20.775395492,  2.654394814 },
      {    0.058844e-6,      426.598190876,  4.839650148 },
      {    0.054139e-6,    17260.154654690,  3.411091093 },
      /* 41, 50 */
      {    0.048373e-6,      155.420399434,  2.251573730 },
      {    0.048042e-6,     2146.165416475,  1.495846011 },
      {    0.046551e-6,       -0.980321068,  0.921573539 },
      {    0.042732e-6,      632.783739313,  5.720622217 },
      {    0.042560e-6,   161000.685737473,  1.270837679 },
      {    0.042411e-6,     6275.962302991,  2.869567043 },
      {    0.040759e-6,    12352.852604545,  3.981496998 },
      {    0.040480e-6,    15720.838784878,  2.546610123 },
      {    0.040184e-6,       -7.113547001,  3.565975565 },
      {    0.036955e-6,     3154.687084896,  5.071801441 },
   /* 51, 60 */
      {    0.036564e-6,     5088.628839767,  3.324679049 },
      {    0.036507e-6,      801.820931124,  6.248866009 },
      {    0.034867e-6,      522.577418094,  5.210064075 },
      {    0.033529e-6,     9437.762934887,  2.404714239 },
      {    0.033477e-6,     6062.663207553,  4.144987272 },
      {    0.032438e-6,     6076.890301554,  0.749317412 },
      {    0.032423e-6,     8827.390269875,  5.541473556 },
      {    0.030215e-6,     7084.896781115,  3.389610345 },
      {    0.029862e-6,    12139.553509107,  1.770181024 },
      {    0.029247e-6,   -71430.695617928,  4.183178762 },

   /* 61, 70 */
      {    0.028244e-6,    -6286.598968340,  5.069663519 },
      {    0.027567e-6,     6279.552731642,  5.040846034 },
      {    0.025196e-6,     1748.016413067,  2.901883301 },
      {    0.024816e-6,    -1194.447010225,  1.087136918 },
      {    0.022567e-6,     6133.512652857,  3.307984806 },
      {    0.022509e-6,    10447.387839604,  1.460726241 },
      {    0.021691e-6,    14143.495242431,  5.952658009 },
      {    0.020937e-6,     8429.241266467,  0.652303414 },
      {    0.020322e-6,      419.484643875,  3.735430632 },
      {    0.017673e-6,     6812.766815086,  3.186129845 },
   /* 71, 80 */
      {    0.017806e-6,       73.297125859,  3.475975097 },
      {    0.016155e-6,    10213.285546211,  1.331103168 },
      {    0.015974e-6,    -2352.866153772,  6.145309371 },
      {    0.015949e-6,     -220.412642439,  4.005298270 },
      {    0.015078e-6,    19651.048481098,  3.969480770 },
      {    0.014751e-6,     1349.867409659,  4.308933301 },
      {    0.014318e-6,    16730.463689596,  3.016058075 },
      {    0.014223e-6,    17789.845619785,  2.104551349 },
      {    0.013671e-6,     -536.804512095,  5.971672571 },
      {    0.012462e-6,      103.092774219,  1.737438797 },
   /* 81, 90 */
      {    0.012420e-6,     4690.479836359,  4.734090399 },
      {    0.011942e-6,     8031.092263058,  2.053414715 },
      {    0.011847e-6,     5643.178563677,  5.489005403 },
      {    0.011707e-6,    -4705.732307544,  2.654125618 },
      {    0.011622e-6,     5120.601145584,  4.863931876 },
      {    0.010962e-6,        3.590428652,  2.196567739 },
      {    0.010825e-6,      553.569402842,  0.842715011 },
      {    0.010396e-6,      951.718406251,  5.717799605 },
      {    0.010453e-6,     5863.591206116,  1.913704550 },
      {    0.010099e-6,      283.859318865,  1.942176992 },

   /* 91, 93 */
      {    0.009858e-6,     6309.374169791,  1.061816410 },
      {    0.009963e-6,      149.563197135,  4.870690598 },
      {    0.009370e-6,   149854.400134205,  0.673880395 },


   /* T */
   /* 94, 103 */ /* B 1,10 */
      {  102.156724e-6,     6283.075849991,  4.249032005 },
      {    1.706807e-6,    12566.151699983,  4.205904248 },
      {    0.269668e-6,      213.299095438,  3.400290479 },
      {    0.265919e-6,      529.690965095,  5.836047367 },
      {    0.210568e-6,       -3.523118349,  6.262738348 },
      {    0.077996e-6,     5223.693919802,  4.670344204 },
      {    0.059146e-6,       26.298319800,  1.083044735 },
      {    0.054764e-6,     1577.343542448,  4.534800170 },
      {    0.034420e-6,     -398.149003408,  5.980077351 },
      {    0.033595e-6,     5507.553238667,  5.980162321 },
   /* 104, 113 */ /* B 11,20 */
      {    0.032088e-6,    18849.227549974,  4.162913471 },
      {    0.029198e-6,     5856.477659115,  0.623811863 },
      {    0.027764e-6,      155.420399434,  3.745318113 },
      {    0.025190e-6,     5746.271337896,  2.980330535 },
      {    0.024976e-6,     5760.498431898,  2.467913690 },
      {    0.022997e-6,     -796.298006816,  1.174411803 },
      {    0.021774e-6,      206.185548437,  3.854787540 },
      {    0.017925e-6,     -775.522611324,  1.092065955 },
      {    0.013794e-6,      426.598190876,  2.699831988 },
      {    0.013276e-6,     6062.663207553,  5.845801920 },
     /* 114, 120 */ /* B 21,27 */
      {    0.012869e-6,     6076.890301554,  5.333425680 },
      {    0.012152e-6,     1059.381930189,  6.222874454 },
      {    0.011774e-6,    12036.460734888,  2.292832062 },
      {    0.011081e-6,       -7.113547001,  5.154724984 },
      {    0.010143e-6,     4694.002954708,  4.044013795 },
      {    0.010084e-6,      522.577418094,  0.749320262 },
      {    0.009357e-6,     5486.777843175,  3.416081409 },
   
   /* T^2 */
   /* 121, 126 */ /* C 1,10 */
      {    0.370115e-6,        0.000000000,  4.712388980 },
      {    4.322990e-6,     6283.075849991,  2.642893748 },
      {    0.122605e-6,    12566.151699983,  2.438140634 },
      {    0.019476e-6,      213.299095438,  1.642186981 },
      {    0.016916e-6,      529.690965095,  4.510959344 },
      {    0.013374e-6,       -3.523118349,  1.502210314 },

   /* T^3 */
   /* 127 */ /* D 1 */
      {    0.143388e-6,     6283.075849991,  1.131453581 }
   };

   /* Time since J2000.0 in Julian millennia. */
   double t = aJulianCenturyFromJ2000(jdTT);
   const double DD2R = 1.745329251994329576923691e-2;


   /* ===================== */
   /* Fairhead et al. model */
   /* ===================== */

   /* T**0 */
   w0 = 0;
   for (j = 92; j >= 0; j--) {
       w0 += fairhd[j][0] * sin(fairhd[j][1] * t + fairhd[j][2]);
   }

   /* T**1 */
   w1 = 0;
   for (j = 119; j >= 93; j--) {
       w1 += fairhd[j][0] * sin(fairhd[j][1] * t + fairhd[j][2]);
   }

   /* T**2 */
   w2 = 0;
   for (j = 125; j >= 120; j--) {
       w2 += fairhd[j][0] * sin(fairhd[j][1] * t + fairhd[j][2]);
   }

   /* T**3 */
   w3 = 0;
   for (j = 126; j >= 126; j--) {
       w3 += fairhd[j][0] * sin(fairhd[j][1] * t + fairhd[j][2]);
   }


   /* Multiply by powers of T and combine. */
   wf = t * (t * (t * (w3) + w2) + w1) + w0;

   /* Adjustments to use JPL planetary masses instead of IAU. */
   wj = 0.00065e-6 * sin(6069.776754 * t + 4.021194) +
       0.00033e-6 * sin(213.299095 * t + 5.543132) +
       (-0.00196e-6 * sin(6208.294251 * t + 5.696701)) +
       (-0.00173e-6 * sin(74.781599 * t + 2.435900)) +
       0.03638e-6 * t * t;

   /* ============ */
   /* Final result */
   /* ============ */
   w = wf + wj;
   return w;
   /* Finished. */
#else
	return iauDtdb(jdTTp1, jdTTp2, 0, 0, 0, 0);
#endif
}


AST_NAMESPACE_END
 
